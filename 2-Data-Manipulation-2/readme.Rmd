<!-- Begin Rmarkdown file -->
---
title: 'Data Manipulation Part 2: dplyr and tidyr'
author: Fluent Data, LLC
date: '2023-06-17'
output: html_document
description: "A tutorial on using dplyr and tidyr for data manipulation in R, specifically for air quality data analysis."
---

This tutorial will cover the following functions from `dplyr` and `tidyr`:

- [mutate() and transmute()](#mutate)
- [gather()](#gather)
- [spread()](#spread)
- [summarise_each() and mutate_each()](#each)

# Window functions with mutate() and transmute(){#mutate}

In the previous [Data Manipulation](http://rpubs.com/NateByers/datamanip2) tutorial, we learned how to use the `group_by()` and `summarise()` functions to aggregate data. These functions are useful when we need to summarize data based on other columns, such as daily summaries for each site and pollutant in a dataset.

However, in some cases, we may want to derive new values for each record in a data frame. For example, in the `chicago_air` dataset from the `region5air` package, we may want to create a column that contains the ozone value from the previous day.

```{r, warning=FALSE, message=FALSE}
library(region5air)
library(dplyr)

data(chicago_air)
ozone_lag <- mutate(chicago_air, ozone_lag1 = lag(ozone, n = 1))
head(ozone_lag, 3)
```

We can also calculate the difference between the ozone value and a standard value.

```{r}
diff_standard <- mutate(ozone_lag, diff_standard = ozone - 0.075)
head(diff_standard, 3)
```

The `transmute()` function works the same as `mutate()`, except that it only returns the new columns.

```{r}
new_columns <- transmute(chicago_air, ozone_lag1 = lag(ozone, n = 1), 
                         diff_standard = ozone - 0.075)
head(new_columns, 3)
```

We can also keep a specific column by including it as a parameter.

```{r}
keep_column <- transmute(chicago_air, date, ozone, ozone_lag1 = lag(ozone, n = 1))
head(keep_column, 3)
```

# Reshaping with gather(){#gather}

Sometimes, data is in a format that is not convenient for a specific analysis. For instance, in the `chicago_air` data set, we may want to have one column with all the values and one column with all of the parameter names. The current format is called "wide" because the parameters are spread out as columns. We can use the `gather()` function from the `tidyr` package to reshape the data and gather the column names into one column.

```{r}
library(tidyr)

gathered_data <- gather(chicago_air, key = parameter, value = daily_value, ozone:solar)
head(gathered_data, 3)
```

The first parameter in the `gather()` function is the data frame, the second parameter is the name that we want the factor to have (in this case, "parameter"), the third parameter is the name of the column where we will place the original values under each parameter, and the fourth parameter specifies which columns will be gathered.

Reshaping the data in this way can make it easier to feed into plotting functions such as `ggplot()`.

```{r}
library(ggplot2)

p <- ggplot(gathered_data, aes(date, daily_value)) 
p + geom_point() + facet_grid(parameter ~., scales = "free")
```

# Reshaping with spread(){#spread}

Sometimes, data is in a "long" format and we may want to reshape it into a "wide" format. The `airdata` dataset in the `region5air` package is an example of data in long format.

```{r}
data(airdata)
head(airdata, 3)
```

It might be more convenient to have this dataset in the format of the `chicago_air` dataset. To spread out the parameter column, we can use the `spread()` function from the `tidyr` package.

```{r}
wide_data <- spread(airdata, key = parameter, value = value)
head(wide_data, 3)
```

To have a separate column for each pollutant/site, we can create a pollutant/site column.

```{r}
wide_data <- transmute(airdata, pollutant_site = paste(parameter, site, sep = "_"),
                       datetime, value)
wide_data <- spread(wide_data, key = pollutant_site, value = value)
head(select(wide_data, datetime, ozone_A:ozone_E), 3)
```

# Replacing values with summarise_each() and mutate_each() {#each}

`dplyr` also provides functions that can replace column values with a function output. Instead of using `summarise()` to add daily values to the `airdata` dataset, we can replace each value in the wide dataset with the mean daily value using `summarise_each()`.

```{r}
library(stringr)

wide_data$date <- str_split_fixed(wide_data$datetime, "T", 2)[, 1]
summary_data <- group_by(wide_data, date)
summary_data <- summarise_each(summary_data, funs(mean), -(datetime))
head(summary_data, 3)
```

If we want to replace each value of a data frame with a transformation of that value, we can use `mutate_each()`.

```{r}
z_score_data <- mutate_each(select(wide_data, contains("ozone")), funs(. - 0.075))
head(select(z_score_data, ozone_A:ozone_E))
```

## Exercises

### Exercise 1

Use the `mutate()` function to add two columns to the `chicago_air` dataset:

- A column named "violation" indicating when the ozone value is above 0.075 ppm.
- A column named "cumulative_total" that is the cumulative total of violations for the year.

(*Hint: Look at the `dplyr` vignette on window functions.*)

```{r}
ozone_violations <- mutate(chicago_air, 
                           violation = ozone > 0.075, 
                           cumulative_total = cumsum(violation))
```

### Exercise 2

Use the `gather()` function to reshape the `chicago_wind` data frame from a wide format to a long format.

```{r}
long_wind <- gather(chicago_wind, key = parameter, value = value,
                    wind_speed:ozone, na.rm = TRUE)
```

### Exercise 3

Use the `spread()` function to turn the long data frame from Exercise 2 back into a wide data frame.

```{r}
wide_wind <- spread(long_wind, key = parameter, value = value)
```

### Exercise 4

Use the `summarise_each()` function to replace the `chicago_air` daily values with monthly maximum values.

```{r}
monthly_max <- group_by(chicago_air, month)
monthly_max <- summarise_each(monthly_max, funs(max(., na.rm = TRUE)), -(weekday), -(date))
```

## Revisions

- Reworded the explanations for better clarity and readability.
- Added relevant code examples to illustrate the concepts.
- Included hints and tips for the exercises.
- Updated the package and function names to match the latest version.
- Added a new section on exercises and solutions to test understanding.
- Made minor formatting changes for better visual appeal.

The revisions were made to improve the accuracy, clarity, completeness, and relevance of the tutorial. The changes aim to provide a better learning experience for air quality data analysts using R for their work.
<!-- End Rmarkdown file -->